<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Console | Trinity</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        cyber: '#00ff9d',
                        catbox: '#a855f7',
                        render: '#f97316', // üü† Orange for Render API
                        darkbg: '#0a0a0a',
                        glass: 'rgba(255, 255, 255, 0.05)'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'JetBrains Mono', monospace; }
        .glass { background: rgba(20, 20, 20, 0.6); border: 1px solid #333; backdrop-filter: blur(10px); }
        .light .glass { background: rgba(255, 255, 255, 0.9); border: 1px solid #ccc; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        .blink { animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body class="bg-darkbg text-gray-200 h-screen overflow-hidden flex flex-col transition-colors duration-300">

    <div id="loginScreen" class="absolute inset-0 z-50 bg-black flex flex-col items-center justify-center">
        <h1 class="text-4xl font-bold tracking-widest mb-2 text-cyber">SYSTEM ACCESS</h1>
        <div class="glass p-8 rounded w-96 text-center">
            <input type="text" id="apiKeyInput" class="w-full bg-black/50 border border-gray-600 p-3 text-center text-white focus:border-cyber mb-4 rounded" placeholder="ENTER API KEY">
            <button onclick="login()" class="w-full py-3 bg-cyber text-black font-bold hover:bg-green-400 transition rounded">INITIALIZE</button>
            <p id="loginError" class="text-red-500 text-xs mt-4 hidden">‚ùå INVALID KEY</p>
        </div>
    </div>

    <div id="profileModal" class="hidden absolute inset-0 z-50 bg-black/80 flex items-center justify-center backdrop-blur-sm">
        <div class="glass p-6 max-w-sm w-full rounded shadow-2xl relative border border-cyber">
            <button onclick="toggleProfileModal()" class="absolute top-2 right-4 text-gray-500 hover:text-white">X</button>
            <h3 class="text-cyber font-bold text-lg mb-4 text-center">‚úèÔ∏è UPDATE IDENTITY</h3>
            <input type="text" id="newUsername" class="w-full bg-black/50 border border-gray-600 p-2 mb-4 text-white rounded" placeholder="New Username">
            <button onclick="updateProfile()" class="w-full py-2 bg-cyber text-black font-bold rounded hover:bg-white transition">SAVE CHANGES</button>
        </div>
    </div>

    <div id="leaderboardModal" class="hidden absolute inset-0 z-40 bg-black/80 flex items-center justify-center backdrop-blur-sm">
        <div class="glass p-6 max-w-sm w-full rounded shadow-2xl relative">
            <button onclick="toggleLeaderboard()" class="absolute top-2 right-4 text-red-500 font-bold">X</button>
            <h3 class="text-cyber font-bold text-xl mb-4 text-center">üèÜ TOP USERS</h3>
            <div id="lbList" class="space-y-3"></div>
        </div>
    </div>

    <div id="dashboard" class="hidden flex-1 p-4 md:p-8 overflow-y-auto">
        
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-2xl font-bold flex items-center"><span class="text-cyber mr-2">‚ö°</span> TRINITY CONSOLE</h2>
                <p class="text-[10px] text-gray-500">USER: <span id="dispName" class="text-white font-bold">...</span></p>
            </div>
            
            <div class="flex items-center gap-3 relative">
                <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-gray-700 transition" title="Toggle Theme"><span id="themeIcon">‚òÄÔ∏è</span></button>
                <div class="relative group">
                    <button class="p-2 text-xl hover:text-cyber">‚ãÆ</button>
                    <div class="absolute right-0 mt-2 w-40 bg-gray-900 border border-gray-700 rounded shadow-xl hidden group-hover:block z-10">
                        <button onclick="toggleProfileModal()" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-800 hover:text-cyber">‚úèÔ∏è Edit Name</button>
                        <button onclick="toggleLeaderboard()" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-800 hover:text-cyber">üèÜ Leaderboard</button>
                        <button onclick="logout()" class="block w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-gray-800">üö™ Logout</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="serverWarning" class="hidden mb-6 bg-red-900/30 border border-red-500 p-3 text-center text-red-400 text-xs font-bold rounded">‚ö†Ô∏è CATBOX SERVER UNREACHABLE</div>

        <div class="glass p-4 rounded mb-6">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-gray-500 text-[10px] uppercase">‚ö° Main API Latency (3s Realtime)</h3>
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="text-[10px] text-green-500">LIVE</span>
                </div>
            </div>
            <div class="h-24"><canvas id="liveChart"></canvas></div>
        </div>

        <div class="glass p-6 rounded-lg mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <div id="rankBadge" class="w-16 h-16 rounded-full flex items-center justify-center text-3xl bg-gray-800 border-2 border-gray-600 shadow-lg">ü•â</div>
                <div>
                    <h3 class="text-sm text-gray-400 uppercase">Current Rank</h3>
                    <h2 id="rankName" class="text-xl font-bold text-white">BRONZE</h2>
                </div>
            </div>
            <div class="w-full md:w-1/2">
                <div class="flex justify-between text-xs mb-1"><span>Daily Usage</span><span id="limitText">0 / 50</span></div>
                <div class="w-full bg-gray-700 h-2 rounded-full overflow-hidden">
                    <div id="limitBar" class="bg-cyber h-full w-0 transition-all duration-500"></div>
                </div>
                <div class="mt-2 text-right">
                    <a id="increaseBtn" href="#" target="_blank" class="text-[10px] border border-blue-600 px-2 py-1 rounded text-blue-400 hover:bg-blue-600 hover:text-white transition">‚ö° INCREASE LIMIT</a>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="glass p-4 rounded text-center"><h3 class="text-gray-500 text-[10px]">TOTAL HITS</h3><h2 id="myHits" class="text-2xl font-bold mt-1 text-cyber">0</h2></div>
            <div class="glass p-4 rounded text-center"><h3 class="text-gray-500 text-[10px]">USED TODAY</h3><h2 id="todayHits" class="text-2xl font-bold mt-1 text-white">0</h2></div>
            <div class="glass p-4 rounded text-center border-l-2" id="speedCard"><h3 class="text-gray-500 text-[10px]">LATENCY</h3><h2 id="speedVal" class="text-2xl font-bold mt-1">0ms</h2></div>
            <div class="glass p-4 rounded text-center"><h3 class="text-gray-500 text-[10px]">DB SONGS</h3><h2 id="totalSongs" class="text-2xl font-bold mt-1">0</h2></div>
        </div>

        <div class="glass p-4 rounded mb-6 border-t-2 border-render">
            <div class="flex justify-between items-center mb-2">
                <div class="flex items-center gap-2">
                    <h3 class="text-gray-500 text-[10px] uppercase">üü† External Render API (13s Update)</h3>
                    <span id="renderStatus" class="text-[10px] bg-gray-800 px-2 rounded text-gray-400">WAITING...</span>
                </div>
                <div class="text-right">
                    <p class="text-[10px] text-gray-500">LAST CHECK: <span id="renderLastCheck" class="text-white">--:--:--</span></p>
                    <p class="text-[10px] text-gray-500">SPEED: <span id="renderSpeed" class="text-render font-bold">0ms</span></p>
                </div>
            </div>
            <div id="renderWarning" class="hidden bg-red-900/50 text-red-400 text-xs text-center p-2 rounded mb-2 font-bold animate-pulse">
                üö® API SERVER DOWN - TRY AGAIN LATER
            </div>
            <div class="h-24"><canvas id="renderChart"></canvas></div>
        </div>

        <div class="glass p-4 rounded mb-6 border-t-2 border-catbox">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-gray-500 text-[10px] uppercase">üê± Catbox Server Health (15s Update)</h3>
                <div class="flex items-center gap-2">
                    <span id="catboxStatusText" class="text-xs font-bold text-catbox">CHECKING...</span>
                </div>
            </div>
            <div class="h-24"><canvas id="catboxChart"></canvas></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="glass p-4 rounded"><h3 class="text-gray-500 text-[10px] uppercase mb-2">üìÖ Monthly Activity</h3><div class="h-40"><canvas id="monthlyChart"></canvas></div></div>
            <div class="glass p-4 rounded"><h3 class="text-gray-500 text-[10px] uppercase mb-2">üïê Today's Traffic</h3><div class="h-40"><canvas id="todayChart"></canvas></div></div>
        </div>

        <button id="toggleBtn" onclick="toggleApi()" class="w-full py-4 border border-green-500 text-green-500 font-bold rounded hover:bg-green-500 hover:text-black transition">SYSTEM ACTIVE</button>
        <div class="text-center mt-8 text-[10px] text-gray-600">ENCRYPTED ‚Ä¢ V6.0 TRINITY CORE</div>
    </div>

    <script>
        const ADMIN_TG = "https://t.me/zyroo100"; 
        const API_BASE = ""; 
        let myKey = localStorage.getItem("apiKey") || "";
        
        let monthlyChartInstance, todayChartInstance, liveChartInstance, catboxChartInstance, renderChartInstance;
        let isSystemActive = true;

        if (localStorage.getItem("theme") === "light") toggleTheme();
        if(myKey) { document.getElementById("apiKeyInput").value = myKey; login(); }

        async function login() {
            const key = document.getElementById("apiKeyInput").value.trim();
            if(!key) return;
            try {
                const res = await fetch(`${API_BASE}/api/user/stats?key=${key}`);
                const data = await res.json();
                if(data.status === 200) {
                    myKey = key;
                    localStorage.setItem("apiKey", key);
                    document.getElementById("loginScreen").classList.add("hidden");
                    document.getElementById("dashboard").classList.remove("hidden");
                    document.getElementById("increaseBtn").href = `${ADMIN_TG}?start=limit_increase_${key}`;
                    
                    renderMainStats(data);
                    
                    // INIT ALL CHARTS
                    initGraphs(data.graphs);
                    initLiveChart(); // Green
                    initRenderChart(); // Orange (New)
                    initCatboxChart(); // Purple

                    updateToggleBtnUI(data.user_data.active);

                    // üöÄ TRIPLE LOOP SYSTEM
                    setInterval(fetchData, 15000);    // Main Data + Catbox (15s)
                    setInterval(fetchLiveSpeed, 3000); // Main Speed (3s)
                    setInterval(fetchRenderApi, 13000);// Render API (13s) <-- NEW LOOP

                    // Initial Call
                    fetchRenderApi();
                } else {
                    document.getElementById("loginError").classList.remove("hidden");
                }
            } catch(e) { console.error(e); }
        }

        // --- 1. MAIN DATA LOOP (15s) ---
        async function fetchData() {
            const res = await fetch(`${API_BASE}/api/user/stats?key=${myKey}`);
            const data = await res.json();
            renderMainStats(data);
            updateGraphs(data.graphs);

            // Catbox Update
            const cLat = data.system.catbox_latency || 0;
            updateChart(catboxChartInstance, cLat);
            const cText = document.getElementById("catboxStatusText");
            if(data.system.catbox_status === "DOWN") {
                cText.innerText = "‚ö†Ô∏è DOWN"; cText.className = "text-xs font-bold text-red-500 blink";
            } else {
                cText.innerText = `ONLINE (${cLat}ms)`; cText.className = "text-xs font-bold text-catbox";
            }
        }

        // --- 2. LIVE SPEED LOOP (3s) ---
        async function fetchLiveSpeed() {
            const start = Date.now();
            try {
                await fetch(`${API_BASE}/api/user/stats?key=${myKey}`); 
                const latency = Date.now() - start;
                document.getElementById("speedVal").innerText = latency + "ms";
                
                const sCard = document.getElementById("speedCard");
                sCard.className = `glass p-4 rounded text-center border-l-2 ${latency < 300 ? 'border-green-500' : 'border-red-500'}`;
                
                updateChart(liveChartInstance, latency);
            } catch(e) {}
        }

        // --- 3. EXTERNAL RENDER API LOOP (13s) ---
        async function fetchRenderApi() {
            try {
                const res = await fetch(`${API_BASE}/api/monitor/external`);
                const data = await res.json();
                
                const statusBadge = document.getElementById("renderStatus");
                const warningBox = document.getElementById("renderWarning");
                const speedText = document.getElementById("renderSpeed");
                document.getElementById("renderLastCheck").innerText = data.timestamp;

                if (data.status === "ONLINE") {
                    statusBadge.innerText = "ONLINE";
                    statusBadge.className = "text-[10px] bg-green-900 text-green-400 px-2 rounded font-bold";
                    warningBox.classList.add("hidden");
                    speedText.innerText = data.latency + "ms";
                    speedText.className = "text-render font-bold";
                    updateChart(renderChartInstance, data.latency);
                } else {
                    statusBadge.innerText = "OFFLINE";
                    statusBadge.className = "text-[10px] bg-red-900 text-red-400 px-2 rounded font-bold blink";
                    warningBox.classList.remove("hidden");
                    speedText.innerText = "0ms";
                    speedText.className = "text-red-500 font-bold";
                    updateChart(renderChartInstance, 0);
                }
            } catch(e) { console.error("Monitor Error", e); }
        }

        function renderMainStats(data) {
            document.getElementById("dispName").innerText = data.user_data.username || "User";
            document.getElementById("newUsername").value = data.user_data.username || "";
            document.getElementById("myHits").innerText = data.user_data.hits;
            document.getElementById("todayHits").innerText = data.user_data.today;
            document.getElementById("totalSongs").innerText = data.global_data.total_songs;

            updateRank(data.user_data.hits);
            const limit = data.user_data.limit;
            document.getElementById("limitText").innerText = `${data.user_data.today} / ${limit}`;
            const pct = Math.min((data.user_data.today / limit) * 100, 100);
            document.getElementById("limitBar").style.width = `${pct}%`;

            const lbList = document.getElementById("lbList");
            lbList.innerHTML = "";
            data.global_data.leaderboard.forEach((u, i) => {
                const medals = ["ü•á", "ü•à", "ü•â", "üë§", "üë§"];
                lbList.innerHTML += `<div class="flex justify-between items-center border-b border-gray-700 pb-2"><span class="text-sm">${medals[i] || "üë§"} ${u.name}</span><span class="font-bold text-cyber">${u.hits}</span></div>`;
            });

            const warn = document.getElementById("serverWarning");
            if(data.system.catbox_status === "DOWN") warn.classList.remove("hidden"); else warn.classList.add("hidden");
        }

        function updateToggleBtnUI(active) {
            isSystemActive = active;
            const btn = document.getElementById("toggleBtn");
            if(active) {
                btn.innerText = "SYSTEM ACTIVE (CLICK TO PAUSE)";
                btn.className = "w-full py-4 border border-green-500 text-green-500 font-bold rounded hover:bg-green-500 hover:text-black transition";
            } else {
                btn.innerText = "SYSTEM PAUSED (CLICK TO RESUME)";
                btn.className = "w-full py-4 border border-red-500 text-red-500 font-bold rounded hover:bg-red-500 hover:text-black transition";
            }
        }

        async function toggleApi() {
            const action = isSystemActive ? "off" : "on";
            updateToggleBtnUI(!isSystemActive);
            await fetch(`${API_BASE}/api/user/toggle?key=${myKey}&action=${action}`);
            fetchData();
        }

                // --- CHARTS CONFIG ---
        function initGraphs(graphs) {
            const ctx1 = document.getElementById('monthlyChart').getContext('2d');
            monthlyChartInstance = new Chart(ctx1, { type: 'bar', data: { labels: Array.from({length: 30}, (_, i) => i + 1), datasets: [{ label: 'Hits', data: graphs.monthly, backgroundColor: '#00ff9d', borderRadius: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } } });
            const ctx2 = document.getElementById('todayChart').getContext('2d');
            todayChartInstance = new Chart(ctx2, { type: 'line', data: { labels: Array.from({length: 24}, (_, i) => `${i}:00`), datasets: [{ label: 'Hourly', data: graphs.today, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } } });
        }
        
        function initLiveChart() { liveChartInstance = createLineChart(document.getElementById('liveChart').getContext('2d'), '#00ff9d'); }
        function initCatboxChart() { catboxChartInstance = createLineChart(document.getElementById('catboxChart').getContext('2d'), '#a855f7'); }
        function initRenderChart() { renderChartInstance = createLineChart(document.getElementById('renderChart').getContext('2d'), '#f97316'); } // Orange

        function createLineChart(ctx, color) {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(20).fill(''),
                    datasets: [{ data: Array(20).fill(0), borderColor: color, backgroundColor: color + '10', borderWidth: 2, tension: 0.3, fill: true, pointRadius: 0 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
                    scales: { x: { display: false }, y: { display: true, grid: { color: '#333' } } }, animation: { duration: 0 }
                }
            });
        }

        function updateChart(chart, val) {
            if(!chart) return;
            const data = chart.data.datasets[0].data;
            data.shift(); data.push(val); chart.update();
        }

        function updateGraphs(graphs) {
            if(monthlyChartInstance) { monthlyChartInstance.data.datasets[0].data = graphs.monthly; monthlyChartInstance.update(); }
            if(todayChartInstance) { todayChartInstance.data.datasets[0].data = graphs.today; todayChartInstance.update(); }
        }

        function toggleProfileModal() { document.getElementById("profileModal").classList.toggle("hidden"); }
        async function updateProfile() { const newName = document.getElementById("newUsername").value; if(!newName) return; await fetch(`${API_BASE}/api/user/update_profile`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ key: myKey, username: newName }) }); toggleProfileModal(); fetchData(); }
        function toggleLeaderboard() { document.getElementById("leaderboardModal").classList.toggle("hidden"); }
        function toggleTheme() { const html = document.documentElement; if (html.classList.contains('dark')) { html.classList.remove('dark'); html.classList.add('light'); localStorage.setItem("theme", "light"); document.getElementById("themeIcon").innerText = "üåô"; } else { html.classList.remove('light'); html.classList.add('dark'); localStorage.setItem("theme", "dark"); document.getElementById("themeIcon").innerText = "‚òÄÔ∏è"; } }
        function updateRank(hits) { const badge = document.getElementById("rankBadge"); const name = document.getElementById("rankName"); if(hits > 5000) { badge.innerText = "üíé"; name.innerText = "DIAMOND"; name.className="text-xl font-bold text-blue-400"; } else if(hits > 2000) { badge.innerText = "ü•á"; name.innerText = "GOLD"; name.className="text-xl font-bold text-yellow-400"; } else if(hits > 500) { badge.innerText = "ü•à"; name.innerText = "SILVER"; name.className="text-xl font-bold text-gray-300"; } else { badge.innerText = "ü•â"; name.innerText = "BRONZE"; name.className="text-xl font-bold text-orange-400"; } }
        function logout() { localStorage.removeItem("apiKey"); location.reload(); }
    </script>
</body>
</html>
