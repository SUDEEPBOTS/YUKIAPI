<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Console | Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        
        body { background-color: #0a0a0a; color: #e5e5e5; font-family: 'JetBrains Mono', monospace; }
        .glass { background: rgba(20, 20, 20, 0.8); border: 1px solid #333; backdrop-filter: blur(10px); }
        .accent { color: #00ff9d; }
        .btn-primary { background: #00ff9d; color: black; font-weight: bold; transition: 0.3s; }
        .btn-primary:hover { background: #00cc7d; box-shadow: 0 0 15px rgba(0, 255, 157, 0.4); }
        
        /* Status Colors */
        .status-good { color: #00ff9d; border-color: #00ff9d; }
        .status-avg { color: #facc15; border-color: #facc15; }
        .status-bad { color: #ff3333; border-color: #ff3333; }

        /* Loader */
        .loader { border-top-color: #00ff9d; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col">

    <div id="loginScreen" class="absolute inset-0 z-50 bg-black flex flex-col items-center justify-center">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold tracking-widest mb-2">SYSTEM ACCESS</h1>
            <p class="text-gray-500 text-xs">SECURE GATEWAY v2.0</p>
        </div>
        <div class="glass p-8 rounded w-96">
            <label class="text-xs text-gray-400 mb-2 block">ENTER API IDENTIFIER</label>
            <input type="text" id="apiKeyInput" class="w-full bg-black border border-gray-700 p-3 text-center text-white focus:outline-none focus:border-green-500 transition mb-4" placeholder="XXXX-XXXX-XXXX">
            <button onclick="login()" class="w-full py-3 btn-primary uppercase tracking-wider text-sm">Initialize Session</button>
            <p id="loginError" class="text-red-500 text-xs mt-4 hidden text-center">❌ AUTHENTICATION FAILED</p>
        </div>
    </div>

    <div id="alertModal" class="hidden absolute inset-0 z-40 bg-black/80 flex items-center justify-center">
        <div class="glass border border-red-500 p-6 max-w-md w-full rounded relative shadow-[0_0_30px_rgba(255,0,0,0.2)]">
            <h3 class="text-red-500 font-bold text-lg mb-2 flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                SYSTEM ALERT
            </h3>
            <p id="alertMsg" class="text-gray-300 text-sm mb-6">...</p>
            <button onclick="closeAlert()" class="w-full border border-red-800 text-red-500 hover:bg-red-900/50 py-2 text-xs">ACKNOWLEDGE & CLOSE</button>
        </div>
    </div>

    <div id="dashboard" class="hidden flex-1 p-6 md:p-10 overflow-y-auto">
        <div class="flex justify-between items-end mb-8 border-b border-gray-800 pb-4">
            <div>
                <h2 class="text-2xl font-bold text-white flex items-center">
                    <svg class="w-6 h-6 mr-3 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    CONSOLE
                </h2>
                <p class="text-xs text-gray-500 mt-1">ID: <span id="dispKey">...</span></p>
            </div>
            <div class="text-right">
                <button onclick="logout()" class="text-xs text-red-500 hover:text-red-400 uppercase tracking-wide">Terminate Session [X]</button>
            </div>
        </div>

        <div id="serverWarning" class="hidden mb-6 bg-red-900/20 border border-red-500/50 p-3 flex items-center justify-center text-red-400 text-xs font-bold">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            CONNECTION INSTABILITY DETECTED: CATBOX SERVERS UNREACHABLE
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            
            <div class="glass p-5 rounded">
                <h3 class="text-gray-500 text-[10px] uppercase tracking-widest mb-2">Personal Usage</h3>
                <div class="flex items-baseline">
                    <h2 id="myHits" class="text-3xl font-bold text-white">0</h2>
                    <span class="text-gray-600 text-xs ml-2">/ REQUESTS</span>
                </div>
            </div>

            <div id="speedCard" class="glass p-5 rounded border-l-4 border-gray-700 transition-colors duration-300">
                <h3 class="text-gray-500 text-[10px] uppercase tracking-widest mb-2">Live Latency</h3>
                <div class="flex items-baseline">
                    <h2 id="speedVal" class="text-3xl font-bold text-white">0</h2>
                    <span class="text-gray-600 text-xs ml-2">ms</span>
                </div>
                <div class="mt-2 w-full bg-gray-800 h-1 rounded overflow-hidden">
                    <div id="speedBar" class="bg-gray-500 h-full w-0 transition-all duration-500"></div>
                </div>
            </div>

            <div class="glass p-5 rounded">
                <h3 class="text-gray-500 text-[10px] uppercase tracking-widest mb-2">Database Index</h3>
                <div class="flex items-baseline">
                    <h2 id="totalSongs" class="text-3xl font-bold text-white">0</h2>
                    <span class="text-gray-600 text-xs ml-2">TRACKS</span>
                </div>
            </div>

            <div class="glass p-5 rounded">
                <h3 class="text-gray-500 text-[10px] uppercase tracking-widest mb-2">Global Traffic</h3>
                <div class="flex items-baseline">
                    <h2 id="globalHits" class="text-3xl font-bold text-white">0</h2>
                    <span class="text-gray-600 text-xs ml-2">HITS</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="glass p-5 rounded md:col-span-2">
                <h3 class="text-gray-500 text-[10px] uppercase tracking-widest mb-4">Network Activity (Realtime)</h3>
                <div class="h-64">
                    <canvas id="liveChart"></canvas>
                </div>
            </div>

            <div class="glass p-5 rounded flex flex-col justify-between">
                <div>
                    <h3 class="text-gray-500 text-[10px] uppercase tracking-widest mb-4">Access Control</h3>
                    <p class="text-xs text-gray-400 mb-6">Manually override API access. Disabling will reject all incoming requests linked to this key.</p>
                </div>
                
                <div class="text-center">
                    <div id="statusIndicator" class="text-xs font-bold mb-3 text-green-500">● SYSTEM ACTIVE</div>
                    <button id="toggleBtn" onclick="toggleApi()" class="w-full py-3 border border-green-500 text-green-500 hover:bg-green-500/10 text-xs font-bold transition">
                        DEACTIVATE API
                    </button>
                </div>
            </div>
        </div>

        <div class="mt-8 text-center text-[10px] text-gray-700">
            SECURE CONNECTION • ENCRYPTED • V2.1.0 BUILD
        </div>
    </div>

    <script>
        let myKey = localStorage.getItem("apiKey") || "";
        let chart;
        
        // Auto Login Check
        if(myKey) {
            document.getElementById("apiKeyInput").value = myKey;
            login();
        }

        async function login() {
            const key = document.getElementById("apiKeyInput").value.trim();
            if(!key) return;

            document.getElementById("loginError").classList.add("hidden");
            
            try {
                // Initial Fetch
                const res = await fetch(`/api/user/stats?key=${key}`);
                const data = await res.json();

                if(data.status === 200) {
                    myKey = key;
                    localStorage.setItem("apiKey", key); // Save Cookie
                    
                    document.getElementById("loginScreen").classList.add("hidden");
                    document.getElementById("dashboard").classList.remove("hidden");
                    document.getElementById("dispKey").innerText = key;
                    
                    initChart();
                    renderData(data);
                    
                    // Start Loop (15s)
                    setInterval(fetchData, 15000);
                } else {
                    document.getElementById("loginError").classList.remove("hidden");
                    localStorage.removeItem("apiKey");
                }
            } catch(e) {
                console.error(e);
                alert("Connection Failed");
            }
        }

        function logout() {
            localStorage.removeItem("apiKey");
            location.reload();
        }

        async function fetchData() {
            const res = await fetch(`/api/user/stats?key=${myKey}`);
            const data = await res.json();
            renderData(data);
        }

        function renderData(data) {
            // 1. Text Stats
            document.getElementById("myHits").innerText = data.user_data.hits;
            document.getElementById("totalSongs").innerText = data.global_data.total_songs;
            document.getElementById("globalHits").innerText = data.global_data.total_requests;
            
            // 2. Speed Logic & Color Coding
            const speed = data.system.api_speed;
            const speedCard = document.getElementById("speedCard");
            const speedBar = document.getElementById("speedBar");
            
            document.getElementById("speedVal").innerText = speed;
            
            // Color Logic
            speedCard.classList.remove("border-green-500", "border-yellow-500", "border-red-500");
            speedBar.classList.remove("bg-green-500", "bg-yellow-500", "bg-red-500");

            if (speed < 300) {
                speedCard.classList.add("border-green-500");
                speedBar.classList.add("bg-green-500");
                speedBar.style.width = "20%";
            } else if (speed < 800) {
                speedCard.classList.add("border-yellow-500");
                speedBar.classList.add("bg-yellow-500");
                speedBar.style.width = "60%";
            } else {
                speedCard.classList.add("border-red-500");
                speedBar.classList.add("bg-red-500");
                speedBar.style.width = "100%";
            }

            // 3. Alerts
            if(data.system.alert) {
                // Show only if not already seen in session (optional logic) or always show
                document.getElementById("alertMsg").innerText = data.system.alert;
                document.getElementById("alertModal").classList.remove("hidden");
            }

            // 4. Server Warning
            const warn = document.getElementById("serverWarning");
            if(data.system.catbox_status === "DOWN") warn.classList.remove("hidden");
            else warn.classList.add("hidden");

            // 5. Chart Update
            updateChart(speed);

            // 6. Active Status Button
            updateToggleBtn(data.user_data.active);
        }

        function updateToggleBtn(isActive) {
            const btn = document.getElementById("toggleBtn");
            const ind = document.getElementById("statusIndicator");
            
            if(isActive) {
                ind.innerText = "● SYSTEM ACTIVE";
                ind.className = "text-xs font-bold mb-3 text-green-500";
                btn.innerText = "DEACTIVATE API";
                btn.className = "w-full py-3 border border-red-500 text-red-500 hover:bg-red-500/10 text-xs font-bold transition";
                btn.onclick = () => toggleApi('off');
            } else {
                ind.innerText = "● SYSTEM PAUSED";
                ind.className = "text-xs font-bold mb-3 text-red-500";
                btn.innerText = "ACTIVATE API";
                btn.className = "w-full py-3 border border-green-500 text-green-500 hover:bg-green-500/10 text-xs font-bold transition";
                btn.onclick = () => toggleApi('on');
            }
        }

        async function toggleApi(action) {
            await fetch(`/api/user/toggle?key=${myKey}&action=${action}`);
            fetchData(); // Refresh UI immediately
        }

        function closeAlert() {
            document.getElementById("alertModal").classList.add("hidden");
        }

        // --- CHART JS ---
        function initChart() {
            const ctx = document.getElementById('liveChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(10).fill(''),
                    datasets: [{
                        label: 'Latency (ms)',
                        data: Array(10).fill(0),
                        borderColor: '#00ff9d',
                        backgroundColor: 'rgba(0, 255, 157, 0.05)',
                        borderWidth: 1.5,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { 
                            border: { display: false },
                            grid: { color: '#222' },
                            ticks: { color: '#555', font: {family: 'JetBrains Mono'} }
                        }
                    },
                    animation: false
                }
            });
        }

        function updateChart(val) {
            if(!chart) return;
            const data = chart.data.datasets[0].data;
            data.shift();
            data.push(val);
            chart.update();
        }
    </script>
</body>
</html>

